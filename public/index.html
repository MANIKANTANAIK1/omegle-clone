<!DOCTYPE html>
<html>
<head>
  <title>Omegle-Style Video Chat</title>
  <style>
    video { width: 45%; margin: 10px; border: 2px solid black; }
    #nextBtn { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Talk to a stranger!</h2>
  <video id="local" autoplay muted playsinline></video>
  <video id="remote" autoplay playsinline></video>
  <br>
  <button id="nextBtn" onclick="location.reload()">Next Stranger</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const localVideo = document.getElementById('local');
    const remoteVideo = document.getElementById('remote');

    let pc;
    let room;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localVideo.srcObject = stream;

      socket.on('partner-found', async (roomName) => {
        room = roomName;
        pc = createPeerConnection(stream);

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('signal', { sdp: offer, room });
      });

      socket.on('signal', async data => {
        if (data.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if (data.sdp.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('signal', { sdp: answer, room });
          }
        } else if (data.candidate) {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      });

      socket.on('partner-disconnected', () => {
        alert("Partner disconnected. Click 'Next' to meet someone new.");
        location.reload();
      });
    });

    function createPeerConnection(stream) {
      const peer = new RTCPeerConnection();

      stream.getTracks().forEach(track => peer.addTrack(track, stream));

      peer.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
      };

      peer.onicecandidate = event => {
        if (event.candidate) {
          socket.emit('signal', { candidate: event.candidate, room });
        }
      };

      return peer;
    }
  </script>
</body>
</html>

